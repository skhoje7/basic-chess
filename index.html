<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chessboard.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 24px; }
    .app { display: grid; grid-template-columns: 320px 1fr; gap: 24px; align-items: start; }
    .controls { display: grid; gap: 12px; }
    label { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    #status { padding: 8px 10px; background: #f6f6f6; border-radius: 8px; min-height: 24px; }
    @media (max-width: 800px) { .app { grid-template-columns: 1fr; } #board { margin-top: 12px; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <label>
        Play as:
        <select id="colorSelect">
          <option value="white">White</option>
          <option value="black">Black</option>
        </select>
      </label>

      <label>
        Difficulty:
        <input id="difficulty" type="range" min="0" max="20" value="5" />
        <span id="diffLabel">5</span>
      </label>

      <button id="newGameBtn">New Game</button>
      <div id="status"></div>
    </div>

    <div id="board" style="width: 420px;"></div>
  </div>

  <!-- Load dependencies in correct order -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    const STOCKFISH_CDN = './stockfish.js';

    let engine;
    function createEngine() {
      try { return new Worker(STOCKFISH_CDN); }
      catch (e) { alert('Stockfish engine failed to load.'); return null; }
    }

    let game = new Chess();
    let board;

    const statusEl = document.getElementById('status');
    const colorSelect = document.getElementById('colorSelect');
    const diffSlider  = document.getElementById('difficulty');
    const diffLabel   = document.getElementById('diffLabel');
    const newGameBtn  = document.getElementById('newGameBtn');

    diffSlider.addEventListener('input', () => diffLabel.textContent = diffSlider.value);

    function onDragStart (source, piece) {
      if (game.game_over()) return false;
      const playerColor = colorSelect.value;
      if ((playerColor === 'white' && piece.startsWith('b')) ||
          (playerColor === 'black' && piece.startsWith('w'))) return false;
      if ((playerColor === 'white' && game.turn() === 'b') ||
          (playerColor === 'black' && game.turn() === 'w')) return false;
      return true;
    }

    function onDrop (source, target) {
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      updateBoardAndStatus();
      setTimeout(engineMove, 200);
    }

    function onSnapEnd () { board.position(game.fen()); }

    function updateBoardAndStatus () {
      board.position(game.fen());
      let status = '';
      const moveColor = (game.turn() === 'w') ? 'White' : 'Black';

      if (game.in_checkmate()) {
        status = 'Game over, ' + (moveColor === 'White' ? 'Black' : 'White') + ' wins by checkmate.';
      } else if (game.in_draw()) {
        status = 'Game over, draw.';
      } else {
        status = moveColor + ' to move' + (game.in_check() ? ' (in check)' : '');
      }
      statusEl.textContent = status;
    }

    function setEngineOptions() {
      if (!engine) return;
      engine.postMessage('uci');
      engine.postMessage('setoption name Skill Level value ' + Number(diffSlider.value));
      engine.postMessage('isready');
    }

    function engineMove() {
      if (!engine || game.game_over()) return;
      engine.onmessage = (e) => {
        const line = typeof e === 'string' ? e : e.data;
        if (typeof line !== 'string') return;
        if (line.startsWith('bestmove')) {
          const parts = line.split(' ');
          const moveStr = parts[1];
          if (!moveStr || moveStr === '(none)') return;
          const from = moveStr.slice(0, 2);
          const to   = moveStr.slice(2, 4);
          const promo = moveStr.slice(4, 5);
          const move = game.move({ from, to, promotion: promo || 'q' });
          if (move) updateBoardAndStatus();
        }
      };
      engine.postMessage('position fen ' + game.fen());
      const ms = Math.max(100, Number(diffSlider.value) * 125);
      engine.postMessage('go movetime ' + ms);
    }

    function startNewGame() {
      game.reset();
      board.orientation(colorSelect.value);
      updateBoardAndStatus();
      if (colorSelect.value === 'black') setTimeout(engineMove, 250);
    }

    function initApp() {
      engine = createEngine();
      setEngineOptions();
      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        orientation: colorSelect.value,
        onDragStart,
        onDrop,
        onSnapEnd
      });
      newGameBtn.addEventListener('click', () => {
        setEngineOptions();
        startNewGame();
      });
      diffLabel.textContent = diffSlider.value;
      startNewGame();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
