<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Stockfish (In-Page, No Worker)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 16px; max-width: 800px; margin: 0 auto; }
  h1 { font-size: 18px; margin: 0 0 12px; }
  label { display:block; font-size:12px; margin: 14px 0 6px; color:#333; }
  textarea { width:100%; min-height:80px; padding:10px; font-size:14px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  input, select, button { padding:10px; font-size:14px; }
  button[disabled] { opacity:.6; cursor:not-allowed; }
  .out { white-space:pre-wrap; background:#f6f8fb; border:1px solid #dce3f3; padding:10px; border-radius:8px; min-height:80px; }
  .pill { display:inline-block; padding:6px 10px; border:1px solid #d0d7e2; border-radius:999px; background:#fff; }
</style>
</head>
<body>
  <h1>Chess Engine (Stockfish, In-Page)</h1>

  <label>FEN</label>
  <textarea id="fen">rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1</textarea>

  <div class="row">
    <label>Side to move</label>
    <select id="side">
      <option value="w">White</option>
      <option value="b" selected>Black</option>
    </select>

    <label>Search</label>
    <select id="mode">
      <option value="movetime" selected>movetime (ms)</option>
      <option value="depth">depth (plies)</option>
    </select>

    <input id="amount" type="number" value="2000" min="100" step="100" />
    <label>Skill (0–20)</label>
    <input id="skill" type="number" value="10" min="0" max="20" />
    <button id="analyze" disabled>Get Best Move</button>
  </div>

  <div class="row" style="margin-top:8px;">
    <span class="pill" id="status">engine: loading…</span>
  </div>

  <label style="margin-top:12px;">Engine output</label>
  <div id="log" class="out"></div>

  <script>
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const analyzeBtn = document.getElementById("analyze");

    function setStatus(s){ statusEl.textContent = s; }
    function log(line){ logEl.textContent += line + "\n"; logEl.scrollTop = logEl.scrollHeight; }

    // Try two CDNs; load as a <script> and use the in-page STOCKFISH() factory.
    const CDN_LIST = [
      "https://cdn.jsdelivr.net/npm/stockfish@16.1.0/stockfish.js",
      "https://unpkg.com/stockfish@16.1.0/stockfish.js"
    ];

    let engine = null;
    let ready = false;

    function clampSkill(v){ v = Number.isFinite(v) ? v : 10; return Math.max(0, Math.min(20, v)); }

    function hookMessages(resolveReady){
      engine.onmessage = (e) => {
        const line = typeof e === "string" ? e : (e.data || "");
        if (!line) return;

        if (line === "uciok") {
          engine.postMessage("isready");
        } else if (line === "readyok") {
          ready = true;
          setStatus("engine: ready");
          analyzeBtn.disabled = false;
          resolveReady?.();
        }

        if (line.startsWith("bestmove")) setStatus(line);
        log(line);
      };
    }

    async function loadEngine() {
      for (const url of CDN_LIST) {
        try {
          await new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = url;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
          // global factory exists now
          engine = window.STOCKFISH();
          hookMessages();
          engine.postMessage("uci");
          // set default skill after a beat
          setTimeout(() => {
            engine.postMessage(`setoption name Skill Level value ${clampSkill(+document.getElementById("skill").value)}`);
          }, 50);
          return; // success
        } catch (e) {
          // try next CDN
        }
      }
      setStatus("engine: failed to load (CDNs blocked?)");
    }

    function analyze() {
      if (!ready) { setStatus("engine: not ready yet"); return; }
      analyzeBtn.disabled = true;
      logEl.textContent = "";
      setStatus("thinking…");

      const fen = document.getElementById("fen").value.trim();
      const side = document.getElementById("side").value;
      const mode = document.getElementById("mode").value;
      const amount = parseInt(document.getElementById("amount").value || "2000", 10);
      const skill = clampSkill(+document.getElementById("skill").value);

      engine.postMessage("ucinewgame");
      engine.postMessage(`setoption name Skill Level value ${skill}`);

      const parts = fen.split(/\s+/);
      if (parts.length >= 2) parts[1] = side;
      const fixedFen = parts.join(" ");

      engine.postMessage(`position fen ${fixedFen}`);
      if (mode === "depth") {
        engine.postMessage(`go depth ${Math.max(1, amount || 12)}`);
      } else {
        engine.postMessage(`go movetime ${Math.max(100, amount || 2000)}`);
      }

      const prevHandler = engine.onmessage;
      engine.onmessage = (e) => {
        const line = typeof e === "string" ? e : (e.data || "");
        if (line) {
          if (line.startsWith("bestmove")) {
            setStatus(line);
            analyzeBtn.disabled = false;
            engine.onmessage = prevHandler; // restore
          }
          log(line);
        }
      };
    }

    analyzeBtn.addEventListener("click", analyze);

    // boot
    loadEngine();
  </script>
</body>
</html>